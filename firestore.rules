rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }
    
    function isAdmin() {
      return hasRole('ADMIN');
    }
    
    function isReviewer() {
      return hasRole('REVIEWER');
    }
    
    function isApplicant() {
      return hasRole('APPLICANT');
    }
    
    function isSchoolAdmin() {
      return hasRole('SCHOOL_ADMIN');
    }
    
    function isSchoolAdminOf(universityId) {
      return isSchoolAdmin() && 
             request.auth.uid in get(/databases/$(database)/documents/universities/$(universityId)).data.adminUids;
    }
    
    // Check if user is staff member of university (new granular roles)
    function isUniversityStaff(universityId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/universities/$(universityId)/staff/$(request.auth.uid));
    }
    
    // Check if user has access to university (admin, legacy adminUids, or staff)
    function hasUniversityAccess(universityId) {
      return isAdmin() || 
             isSchoolAdminOf(universityId) || 
             isUniversityStaff(universityId);
    }
    
    // Users collection - users can read/update their own data, admins can manage all
    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin() || isReviewer();
      allow create: if isOwner(uid);
      allow update: if isOwner(uid) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Profiles collection - users can read/write their own profile
    match /profiles/{uid} {
      allow read: if isOwner(uid) || isAdmin() || isReviewer();
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
      allow delete: if isAdmin();
    }
    
    // Universities collection - public read, admin write, school admins can update their own
    match /universities/{id} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin() || hasUniversityAccess(id);
      allow delete: if isAdmin();
      
      // University staff subcollection - granular roles
      match /staff/{userId} {
        allow read: if hasUniversityAccess(id);
        allow write: if isAdmin() || (hasUniversityAccess(id) && get(/databases/$(database)/documents/universities/$(id)/staff/$(request.auth.uid)).data.role == 'UNI_ADMIN');
      }
    }
    
    // University Registrations - anyone can create, only admins can review
    match /universityRegistrations/{id} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Programs collection - public read, admin and school admins can write
    match /programs/{id} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isSchoolAdmin();
      allow update: if isAdmin() || (isSchoolAdmin() && request.auth.uid in get(/databases/$(database)/documents/universities/$(resource.data.universityId)).data.adminUids);
      allow delete: if isAdmin();
    }
    
    // Applications collection - users can CRUD their own applications
    match /applications/{id} {
      allow read: if isAuthenticated() && 
                     (resource.data.applicantUid == request.auth.uid || isAdmin() || isReviewer());
      allow create: if isAuthenticated() && request.resource.data.applicantUid == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.applicantUid == request.auth.uid || isAdmin() || isReviewer());
      allow delete: if isAdmin();
    }
    
    // Application Items - applicants, admins, reviewers, and school admins of the university can read
    match /applicationItems/{id} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      isAdmin() || 
                      isReviewer() ||
                      hasUniversityAccess(resource.data.universityId));
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() || 
                       isAdmin() || 
                       hasUniversityAccess(resource.data.universityId);
      allow delete: if isAdmin();
      
      // Application documents subcollection
      match /documents/{docId} {
        allow read: if isAuthenticated() && 
                       (get(/databases/$(database)/documents/applicationItems/$(id)).data.userId == request.auth.uid || 
                        isAdmin() || 
                        hasUniversityAccess(get(/databases/$(database)/documents/applicationItems/$(id)).data.universityId));
        allow write: if isAuthenticated() && 
                        (get(/databases/$(database)/documents/applicationItems/$(id)).data.userId == request.auth.uid || 
                         isAdmin() || 
                         hasUniversityAccess(get(/databases/$(database)/documents/applicationItems/$(id)).data.universityId));
      }
      
      // Application notes subcollection
      match /notes/{noteId} {
        allow read: if isAuthenticated() && 
                       ((!resource.data.isInternal && get(/databases/$(database)/documents/applicationItems/$(id)).data.userId == request.auth.uid) || 
                        isAdmin() || 
                        hasUniversityAccess(get(/databases/$(database)/documents/applicationItems/$(id)).data.universityId));
        allow create: if isAuthenticated() && 
                         (get(/databases/$(database)/documents/applicationItems/$(id)).data.userId == request.auth.uid || 
                          isAdmin() || 
                          hasUniversityAccess(get(/databases/$(database)/documents/applicationItems/$(id)).data.universityId));
        allow update: if isAuthenticated() && 
                         (resource.data.authorId == request.auth.uid || isAdmin());
        allow delete: if isAdmin();
      }
      
      // Application timeline subcollection (audit trail - append only)
      match /timeline/{eventId} {
        allow read: if isAuthenticated() && 
                       (get(/databases/$(database)/documents/applicationItems/$(id)).data.userId == request.auth.uid || 
                        isAdmin() || 
                        hasUniversityAccess(get(/databases/$(database)/documents/applicationItems/$(id)).data.universityId));
        allow create: if isAuthenticated() && 
                         (isAdmin() || 
                          hasUniversityAccess(get(/databases/$(database)/documents/applicationItems/$(id)).data.universityId));
        allow update, delete: if false; // Timeline events are immutable
      }
    }
    
    // Documents collection - users can CRUD their own documents
    match /documents/{id} {
      allow read: if isAuthenticated() && 
                     (resource.data.ownerUid == request.auth.uid || isAdmin() || isReviewer());
      allow create: if isAuthenticated() && request.resource.data.ownerUid == request.auth.uid;
      allow update: if isOwner(resource.data.ownerUid);
      allow delete: if isOwner(resource.data.ownerUid) || isAdmin();
    }
    
    // Notifications collection - users can read their own notifications
    match /notifications/{id} {
      allow read: if isAuthenticated() && resource.data.recipientUid == request.auth.uid;
      allow create: if isAdmin(); // Only server/admin can create notifications
      allow update: if isAuthenticated() && resource.data.recipientUid == request.auth.uid;
      allow delete: if isOwner(resource.data.recipientUid) || isAdmin();
    }
    
    // Audit logs - admin read only, server writes
    match /auditLogs/{id} {
      allow read: if isAdmin();
      allow write: if false; // Only server can write audit logs
    }
    
    // Admin Access - tracks admin users and their access levels (VIEWER/ADMIN)
    match /adminAccess/{uid} {
      allow read: if isAdmin();
      allow write: if false; // Only server can manage admin access
    }
    
    // Admin Invitations - pending admin invitations
    match /adminInvitations/{id} {
      allow read: if isAdmin();
      allow write: if false; // Only server can manage invitations
    }
    
    // Team Invitations - pending school team invitations
    match /teamInvitations/{id} {
      allow read: if isAuthenticated() && 
                     (resource.data.email == request.auth.token.email || isAdmin());
      allow write: if false; // Only server can manage team invitations
    }
    
    // Platform Settings - global platform configuration
    match /platformSettings/{id} {
      allow read: if isAuthenticated();
      allow write: if false; // Only server/admin can update platform settings
    }
    
    // Message Templates - university-specific templates
    match /messageTemplates/{id} {
      allow read: if isAuthenticated() && hasUniversityAccess(resource.data.universityId);
      allow create: if isAuthenticated() && hasUniversityAccess(request.resource.data.universityId);
      allow update: if isAuthenticated() && hasUniversityAccess(resource.data.universityId);
      allow delete: if isAdmin() || hasUniversityAccess(resource.data.universityId);
    }
    
    // Payments - enhanced rules for finance role
    match /payments/{id} {
      allow read: if isAuthenticated() && 
                     (resource.data.studentId == request.auth.uid || 
                      isAdmin() || 
                      hasUniversityAccess(resource.data.universityId));
      allow create: if isAuthenticated();
      allow update: if isAdmin() || hasUniversityAccess(resource.data.universityId);
      allow delete: if isAdmin();
    }
  }
}
